openapi: 3.0.0
info:
  title: Nubo Hub App Supabase API
  version: 1.0.0
  description: >
    Documentation of the Supabase tables, views, and RPCs used by the Nubo Hub Web App (nubo-hub-app).
    These resources are consumed by the frontend (Next.js) via supabase-js.
servers:
  - url: https://yfgciamhzjvarwgzosto.supabase.co/rest/v1
    description: Supabase REST API Endpoint

components:
  securitySchemes:
    apikey:
      type: apiKey
      name: apikey
      in: header
    bearerAuth:
      type: http
      scheme: bearer
  schemas:
    CourseDisplayData:
      type: object
      properties:
        id:
          type: string
          format: uuid
        course_name:
          type: string
        institution_name:
          type: string
        city:
          type: string
        state:
          type: string
        opportunities:
          type: array
          items:
            type: object
            properties:
                id:
                    type: string
                    format: uuid
                shift:
                    type: string
                scholarship_type:
                    type: string
                opportunity_type:
                    type: string
                cutoff_score:
                    type: number
                    format: float
    OpportunityView:
      type: object
      description: Read-only view. Matches database.types.ts OpportunityRow + join fields
      properties:
        id:
          type: string
          format: uuid
        course_id:
          type: string
          format: uuid
        course:
          type: string
        institution:
          type: string
        city:
          type: string
        state:
          type: string
        shift:
          type: string
        scholarship_type:
          type: string
        cutoff_score:
            type: number
            format: float
        opportunity_type:
          type: string
    RPCCoursesResponse:
        type: array
        items:
            $ref: '#/components/schemas/CourseDisplayData'

security:
  - apikey: []
  - bearerAuth: []

paths:
  /rpc/get_courses_with_opportunities:
    post:
      summary: Get Courses with Opportunities (Paged)
      description: >
        Main RPC used to list courses on the Explore page. 
        Returns courses joined with their opportunities (grouped as JSON).
        Used by `fetchCoursesWithOpportunities`.
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [page_number, page_size]
              properties:
                page_number:
                  type: integer
                  description: 0-indexed page number
                page_size:
                  type: integer
                  description: Number of items per page
                search_query:
                  type: string
                  nullable: true
                category:
                  type: string
                  nullable: true
                  enum: [SISU, Prouni, EAD, 'Ações afirmativas']
                sort_by:
                  type: string
                  nullable: true
                  enum: [proximas, melhores, maior_nota, menor_nota]
                user_city:
                  type: string
                  nullable: true
                user_state:
                  type: string
                  nullable: true
      responses:
        '200':
          description: List of courses
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RPCCoursesResponse'

  /opportunities_view:
    get:
      summary: Get Opportunities by Course IDs
      description: >
        Used by `fetchOpportunitiesByCourseIds`. 
        Fetches detailed opportunity info for a specific list of courses.
      parameters:
        - name: course_id
          in: query
          description: Filter by list of Course IDs (in)
          schema:
            type: string
            example: "in.(uuid1,uuid2)"
        - name: select
          in: query
          description: Columns to select
          schema:
            type: string
            default: "*"
      responses:
        '200':
          description: List of opportunities
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OpportunityView'

  /courses:
    get:
      summary: Get Course Details
      description: >
        Fetches detailed information for a specific course, including nested relations:
        opportunities, campus (with institution), and institution details (EMEC, SISU).
        Used by `getCourseDetails`.
      parameters:
        - name: id
          in: query
          required: true
          description: Course ID (eq.UUID)
          schema:
            type: string
            format: uuid
        - name: select
          in: query
          description: PostgREST select query with nested embeddings
          schema:
            type: string
      responses:
        '200':
          description: Course details object
          content:
             application/json:
               schema:
                 type: array
                 items:
                   $ref: '#/components/schemas/CourseDetail'

    CourseDetail:
      type: object
      properties:
        id:
          type: string
          format: uuid
        course_name:
          type: string
        course_code:
          type: string
        vacancies:
          type: integer
        opportunities:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              semester:
                type: string
              shift:
                type: string
              scholarship_type:
                type: string
              cutoff_score:
                type: number
        campus:
          type: object
          properties:
            name:
              type: string
            city:
              type: string
            state:
              type: string
            region:
              type: string
            institutions:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                name:
                  type: string
                external_code:
                  type: string
                institutionsinfoemec:
                  type: array # Usually 1:1 but supabase returns array for has_many if not single()
                  items:
                    type: object
                    properties:
                      phone:
                        type: string
                      site:
                        type: string
                      email:
                        type: string
                      academic_organization:
                        type: string
                      credentialing_type:
                        type: string
                      administrative_category:
                        type: string
                      creation_date:
                        type: string
                      ci:
                         type: integer
                      ci_ead:
                         type: integer
                      igc:
                         type: integer
                institutionsinfosisu:
                  type: array
                  items:
                    type: object
                    properties:
                      acronym:
                        type: string
    Partner:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        location:
          type: string
        type:
          type: string
        income:
          type: string
        dates:
          type: object # jsonb
        link:
          type: string
        coverimage:
          type: string
  /rpc/get_partners:
     post:
       summary: Get All Partners
       description: Returns all partners ordered by name.
       responses:
         '200':
           description: List of partners
           content:
             application/json:
               schema:
                 type: array
                 items:
                   $ref: '#/components/schemas/Partner'

  /rpc/get_user_favorites_details:
     post:
       summary: Get User Favorites Details
       description: Returns details of courses and partners favorited by the current user.
       responses:
         '200':
           description: Object containing lists of courses and partners
           content:
             application/json:
               schema:
                 type: object
                 properties:
                   courses:
                     type: array
                     items:
                       $ref: '#/components/schemas/CourseDisplayData'
                   partners:
                     type: array
                     items:
                       $ref: '#/components/schemas/Partner'

  /rpc/update_own_profile:
     post:
       summary: Update User Profile
       description: Updates the user's profile and returns the updated record. Sets onboarding_completed to true if all fields are filled.
       requestBody:
         content:
           application/json:
             schema:
               type: object
               properties:
                 p_full_name:
                   type: string
                   nullable: true
                 p_age:
                   type: integer
                   nullable: true
                 p_city:
                   type: string
                   nullable: true
                 p_education:
                   type: string
                   nullable: true
       responses:
         '200':
           description: Updated profile object
           content:
             application/json:
               schema:
                 type: object
                 additionalProperties: true

  /rpc/get_own_profile:
     post:
       summary: Get Own Profile (Secure)
       description: Returns the user's profile using a SECURITY DEFINER RPC.
       responses:
         '200':
           description: Profile object or null
           content:
             application/json:
               schema:
                 type: object
                 additionalProperties: true
                 nullable: true
